{% extends "base.html" %}

{% block title %}Reports - WMS{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h1><i class="fas fa-chart-bar me-2"></i>Reports & Analytics</h1>
    <div class="dropdown">
        <button class="btn btn-outline-secondary dropdown-toggle" type="button" data-bs-toggle="dropdown">
            <i class="fas fa-download me-2"></i>Export
        </button>
        <ul class="dropdown-menu">
            <li><a class="dropdown-item" href="#" onclick="exportReport('pdf')">
                <i class="fas fa-file-pdf me-2"></i>Export as PDF
            </a></li>
            <li><a class="dropdown-item" href="#" onclick="exportReport('excel')">
                <i class="fas fa-file-excel me-2"></i>Export as Excel
            </a></li>
            <li><a class="dropdown-item" href="#" onclick="exportReport('csv')">
                <i class="fas fa-file-csv me-2"></i>Export as CSV
            </a></li>
        </ul>
    </div>
</div>

<!-- Date Range Filter -->
<div class="card mb-4">
    <div class="card-body">
        <form method="GET" class="row align-items-end">
            <div class="col-md-3">
                <label for="start_date" class="form-label">From Date</label>
                <input type="date" class="form-control" name="start_date" id="start_date" 
                       value="{{ request.args.get('start_date', '') }}">
            </div>
            <div class="col-md-3">
                <label for="end_date" class="form-label">To Date</label>
                <input type="date" class="form-control" name="end_date" id="end_date" 
                       value="{{ request.args.get('end_date', '') }}">
            </div>
            <div class="col-md-3">
                <label for="branch_filter" class="form-label">Branch</label>
                <select class="form-select" name="branch_filter" id="branch_filter">
                    <option value="">All Branches</option>
                    <option value="1" {{ 'selected' if request.args.get('branch_filter') == '1' }}>Main Branch</option>
                    <option value="2" {{ 'selected' if request.args.get('branch_filter') == '2' }}>Warehouse A</option>
                    <option value="3" {{ 'selected' if request.args.get('branch_filter') == '3' }}>Warehouse B</option>
                </select>
            </div>
            <div class="col-md-3">
                <button type="submit" class="btn btn-primary">
                    <i class="fas fa-filter me-2"></i>Apply Filter
                </button>
                <a href="{{ url_for('reports') }}" class="btn btn-outline-secondary">
                    <i class="fas fa-times me-2"></i>Clear
                </a>
            </div>
        </form>
    </div>
</div>

<div class="row">
    <!-- GRPO Status Chart -->
    <div class="col-md-6 mb-4">
        <div class="card">
            <div class="card-header">
                <h5><i class="fas fa-chart-pie me-2"></i>GRPO Status Distribution</h5>
            </div>
            <div class="card-body">
                <canvas id="grpoStatusChart" width="400" height="200"></canvas>
            </div>
        </div>
    </div>

    <!-- Monthly GRPO Trend -->
    <div class="col-md-6 mb-4">
        <div class="card">
            <div class="card-header">
                <h5><i class="fas fa-chart-line me-2"></i>Monthly GRPO Trend</h5>
            </div>
            <div class="card-body">
                <canvas id="monthlyGrpoChart" width="400" height="200"></canvas>
            </div>
        </div>
    </div>
</div>

<div class="row">
    <!-- Summary Statistics -->
    <div class="col-md-4 mb-4">
        <div class="card">
            <div class="card-header">
                <h5><i class="fas fa-calculator me-2"></i>Summary Statistics</h5>
            </div>
            <div class="card-body">
                <div class="row text-center">
                    <div class="col-12 mb-3">
                        <h3 class="text-primary">{{ grpo_by_status|length }}</h3>
                        <p class="text-muted">Total Status Categories</p>
                    </div>
                    <div class="col-12 mb-3">
                        <h3 class="text-success">{{ monthly_grpos|length }}</h3>
                        <p class="text-muted">Active Months</p>
                    </div>
                    <div class="col-12">
                        <h3 class="text-info">{{ session.branch_id or 'All' }}</h3>
                        <p class="text-muted">Current Branch</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Top Suppliers -->
    <div class="col-md-4 mb-4">
        <div class="card">
            <div class="card-header">
                <h5><i class="fas fa-truck me-2"></i>Top Suppliers</h5>
            </div>
            <div class="card-body">
                <div class="list-group list-group-flush">
                    <div class="list-group-item d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="mb-1">Supplier A</h6>
                            <p class="mb-1 text-muted">Electronics & Components</p>
                        </div>
                        <span class="badge bg-primary rounded-pill">45</span>
                    </div>
                    <div class="list-group-item d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="mb-1">Supplier B</h6>
                            <p class="mb-1 text-muted">Raw Materials</p>
                        </div>
                        <span class="badge bg-primary rounded-pill">32</span>
                    </div>
                    <div class="list-group-item d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="mb-1">Supplier C</h6>
                            <p class="mb-1 text-muted">Packaging Materials</p>
                        </div>
                        <span class="badge bg-primary rounded-pill">28</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- QC Performance -->
    <div class="col-md-4 mb-4">
        <div class="card">
            <div class="card-header">
                <h5><i class="fas fa-check-double me-2"></i>QC Performance</h5>
            </div>
            <div class="card-body">
                <div class="mb-3">
                    <div class="d-flex justify-content-between">
                        <span>Approval Rate</span>
                        <span class="text-success">95%</span>
                    </div>
                    <div class="progress">
                        <div class="progress-bar bg-success" style="width: 95%"></div>
                    </div>
                </div>
                <div class="mb-3">
                    <div class="d-flex justify-content-between">
                        <span>Rejection Rate</span>
                        <span class="text-danger">5%</span>
                    </div>
                    <div class="progress">
                        <div class="progress-bar bg-danger" style="width: 5%"></div>
                    </div>
                </div>
                <div class="mb-3">
                    <div class="d-flex justify-content-between">
                        <span>Avg. Processing Time</span>
                        <span class="text-info">2.5 hours</span>
                    </div>
                    <div class="progress">
                        <div class="progress-bar bg-info" style="width: 70%"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Detailed Reports Table -->
<div class="row">
    <div class="col-md-12">
        <div class="card">
            <div class="card-header">
                <h5><i class="fas fa-table me-2"></i>Detailed GRPO Report</h5>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-striped" id="detailedReportTable">
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>GRN Number</th>
                                <th>PO Number</th>
                                <th>Supplier</th>
                                <th>Status</th>
                                <th>Items</th>
                                <th>Total Amount</th>
                                <th>QC Status</th>
                                <th>SAP Posted</th>
                            </tr>
                        </thead>
                        <tbody>
                            <!-- Table will be populated by JavaScript -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Key Performance Indicators -->
<div class="row mt-4">
    <div class="col-md-12">
        <div class="card">
            <div class="card-header">
                <h5><i class="fas fa-tachometer-alt me-2"></i>Key Performance Indicators</h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-3 text-center">
                        <div class="card bg-primary text-white">
                            <div class="card-body">
                                <h3>98.5%</h3>
                                <p class="mb-0">On-Time Delivery</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3 text-center">
                        <div class="card bg-success text-white">
                            <div class="card-body">
                                <h3>99.2%</h3>
                                <p class="mb-0">Accuracy Rate</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3 text-center">
                        <div class="card bg-warning text-white">
                            <div class="card-body">
                                <h3>1.8 hrs</h3>
                                <p class="mb-0">Avg. Processing Time</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3 text-center">
                        <div class="card bg-info text-white">
                            <div class="card-body">
                                <h3>95%</h3>
                                <p class="mb-0">SAP Integration Success</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
// GRPO Status Distribution Chart
const statusCtx = document.getElementById('grpoStatusChart').getContext('2d');
const statusChart = new Chart(statusCtx, {
    type: 'doughnut',
    data: {
        labels: [
            {% for status, count in grpo_by_status %}
            '{{ status.value.replace("_", " ").title() }}',
            {% endfor %}
        ],
        datasets: [{
            data: [
                {% for status, count in grpo_by_status %}
                {{ count }},
                {% endfor %}
            ],
            backgroundColor: [
                '#0d6efd',
                '#6f42c1',
                '#fd7e14',
                '#20c997',
                '#dc3545',
                '#ffc107'
            ]
        }]
    },
    options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
            legend: {
                position: 'bottom',
            }
        }
    }
});

// Monthly GRPO Trend Chart
const monthlyCtx = document.getElementById('monthlyGrpoChart').getContext('2d');
const monthlyChart = new Chart(monthlyCtx, {
    type: 'line',
    data: {
        labels: [
            {% for month, count in monthly_grpos %}
            '{{ month }}',
            {% endfor %}
        ],
        datasets: [{
            label: 'GRPOs Created',
            data: [
                {% for month, count in monthly_grpos %}
                {{ count }},
                {% endfor %}
            ],
            borderColor: '#0d6efd',
            backgroundColor: 'rgba(13, 110, 253, 0.1)',
            tension: 0.4,
            fill: true
        }]
    },
    options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
            legend: {
                display: false
            }
        },
        scales: {
            y: {
                beginAtZero: true
            }
        }
    }
});

// Export functionality
function exportReport(format) {
    const startDate = document.getElementById('start_date').value;
    const endDate = document.getElementById('end_date').value;
    const branch = document.getElementById('branch_filter').value;
    
    let url = `/reports/export?format=${format}`;
    if (startDate) url += `&start_date=${startDate}`;
    if (endDate) url += `&end_date=${endDate}`;
    if (branch) url += `&branch=${branch}`;
    
    // In a real implementation, this would trigger a download
    alert(`Exporting report as ${format.toUpperCase()}...`);
}

// Load detailed report data
function loadDetailedReport() {
    // In a real implementation, this would fetch data from the server
    const tableBody = document.querySelector('#detailedReportTable tbody');
    const sampleData = [
        {
            date: '2024-01-15',
            grn: 'GRN20240115001',
            po: 'PO-2024-001',
            supplier: 'Supplier A',
            status: 'Posted to SAP',
            items: 5,
            amount: 15000.00,
            qc_status: 'Approved',
            sap_posted: 'Yes'
        },
        {
            date: '2024-01-14',
            grn: 'GRN20240114001',
            po: 'PO-2024-002',
            supplier: 'Supplier B',
            status: 'Pending QC',
            items: 3,
            amount: 8500.00,
            qc_status: 'Pending',
            sap_posted: 'No'
        }
    ];
    
    tableBody.innerHTML = sampleData.map(row => `
        <tr>
            <td>${row.date}</td>
            <td>${row.grn}</td>
            <td>${row.po}</td>
            <td>${row.supplier}</td>
            <td><span class="badge bg-${row.status.includes('Posted') ? 'success' : 'warning'}">${row.status}</span></td>
            <td>${row.items}</td>
            <td>$${row.amount.toFixed(2)}</td>
            <td><span class="badge bg-${row.qc_status === 'Approved' ? 'success' : 'warning'}">${row.qc_status}</span></td>
            <td><span class="badge bg-${row.sap_posted === 'Yes' ? 'success' : 'secondary'}">${row.sap_posted}</span></td>
        </tr>
    `).join('');
}

// Load data on page load
document.addEventListener('DOMContentLoaded', function() {
    loadDetailedReport();
});

// Auto-refresh charts every 5 minutes
setInterval(function() {
    // In a real implementation, this would refresh the chart data
    console.log('Refreshing report data...');
}, 300000);
</script>
{% endblock %}
